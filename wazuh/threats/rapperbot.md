# RapperBot Simulation

This document outlines the steps to simulate a RapperBot malware attack and how the Wazuh monitoring system detects the behavior. The attack involves modifying system-critical files and adding malicious SSH keys, triggering custom Wazuh rules.

---

## **Simulation Steps**

### **1. Create a Custom Wazuh Rule**
Define a custom rule to detect RapperBot behavior in your Wazuh installation. Add the following rule to your Wazuh rules configuration:

```xml
<group name="rapperbot,">
    <rule id="100025" level="12">
        <if_sid>550,554</if_sid>
        <field name="file" type="pcre2">(^\/etc\/shadow$)|(\/authorized_keys$)|(\/etc/\cron.hourly\/0)</field>
        <match type="pcre2">(suhelper:.*OJBlhUV.*\/)|(^.*\/SFBTD5VEo95K2ZLQ== system key generated by server 20220709$)|(suhelper)</match>
        <description>[User Creation & Public SSH Key Insertion]: Possible RapperBot malware detected in system.</description>
        <mitre>
            <id>T1053.003</id>
        </mitre>
    </rule>
</group>
```

 * **Rule ID 554**: Triggered when the /etc/cron.hourly/0 file is added.
 * **Rule ID 550**: Triggered when /etc/passwd or /root/.ssh/authorized_keys are modified.
 * **Rule ID 100025**: Custom rule for RapperBot behavior.

## **2. Simulate the Attack**

### **Modify the `/etc/passwd` File**
Add a malicious user with root privileges to `/etc/passwd`:

```bash
echo "suhelper:x:0:0:root:/root:/bin/bash" | sudo tee -a /etc/passwd
```

### **Add Malicious SSH Key**
Insert a malicious public SSH key into `/root/.ssh/authorized_keys`:

```bash
echo "ssh-rsa AAAAB3... user@domain" | sudo tee -a /root/.ssh/authorized_keys
```

### **Create a Malicious Cron Job**
Create a file in `/etc/cron.hourly/` to simulate the malware's persistence mechanism:

```bash
echo "suhelper:malicious_command" | sudo tee /etc/cron.hourly/0
sudo chmod +x /etc/cron.hourly/0
```

---

## **3. Verify the Changes**

### **Check `/etc/passwd`:**

```bash
sudo tail -n 5 /etc/passwd
```

### **Check `/root/.ssh/authorized_keys`:**

```bash
sudo cat /root/.ssh/authorized_keys
```

### **Check `/etc/cron.hourly/0`:**

```bash
sudo cat /etc/cron.hourly/0
```

---

## **4. Monitor Wazuh Alerts**
Once the above changes are made, Wazuh should generate alerts based on the defined rules. Open the Wazuh dashboard and navigate to the **Security Events** tab to view the alerts:

- **Rule ID 554**: Triggered for the `/etc/cron.hourly/0` modification.
- **Rule ID 550**: Triggered for the `/etc/passwd` or `/root/.ssh/authorized_keys` modifications.
- **Rule ID 100025**: Custom rule triggered for RapperBot behavior.

---

## **5. Cleanup**
After the simulation, revert the changes to avoid leaving the system in a compromised state.

### **Remove Malicious User from `/etc/passwd`:**

```bash
sudo sed -i '/suhelper/d' /etc/passwd
```

### **Remove Malicious SSH Key:**

```bash
sudo sed -i '/AAAAB3... user@domain/d' /root/.ssh/authorized_keys
```

### **Remove Malicious Cron Job:**

```bash
sudo rm -f /etc/cron.hourly/0
```

---

## **Conclusion**
By following the steps above, you can simulate a RapperBot attack and observe how Wazuh detects and alerts on malicious behavior. Ensure all changes are reverted after the simulation to maintain system integrity.

https://wazuh.com/blog/rapperbot-botnet-detection-and-mitigation-with-wazuh/

https://www.fortinet.com/blog/threat-research/rapperbot-malware-discovery

