# Detecting and Removing Malware Using VirusTotal Integration

Wazuh uses the integrator module to connect to external APIs and alerting tools such as VirusTotal. This guide explains how to use Wazuh File Integrity Monitoring (FIM) to monitor directories for changes, integrate with VirusTotal API to scan files, and configure Wazuh to remove files flagged as malicious. Instructions are provided for Ubuntu and Windows endpoints.

---

## Prerequisites
- A VirusTotal API key to authenticate Wazuh to the VirusTotal API.
- Wazuh server and agent installed on both Ubuntu and Windows endpoints.

---

## Infrastructure

### Endpoint Description
| Endpoint   | Description                                                                                         |
|------------|-----------------------------------------------------------------------------------------------------|
| Ubuntu 22.04 | Monitors the `/root` directory for changes and removes malicious files flagged by VirusTotal.      |
| Windows 11 | Monitors the `C:\Users\<USER_NAME>\Downloads` directory and removes malicious files flagged by VirusTotal. |

---

## Configuration for Ubuntu Endpoint

### Step 1: Configure Wazuh Agent

1. **Enable FIM Monitoring:**
   - Open the Wazuh agent configuration file:
     ```bash
     sudo nano /var/ossec/etc/ossec.conf
     ```
   - Ensure `<disabled>` is set to `no` in the `<syscheck>` block:
     ```xml
     <syscheck>
         <disabled>no</disabled>
     </syscheck>
     ```
   - Add the following entry to monitor the `/root` directory in real-time:
     ```xml
     <directories realtime="yes">/root</directories>
     ```

2. **Install `jq` for JSON Processing:**
   ```bash
   sudo apt update
   sudo apt -y install jq
   ```

3. **Create Active Response Script:**
   - Save the following script to `/var/ossec/active-response/bin/remove-threat.sh`:
     ```bash
     #!/bin/bash

     LOCAL=`dirname $0`;
     cd $LOCAL
     cd ../

     PWD=`pwd`

     read INPUT_JSON
     FILENAME=$(echo $INPUT_JSON | jq -r .parameters.alert.data.virustotal.source.file)
     COMMAND=$(echo $INPUT_JSON | jq -r .command)
     LOG_FILE="${PWD}/../logs/active-responses.log"

     if [ ${COMMAND} = "add" ]; then
         printf '{"version":1,"origin":{"name":"remove-threat","module":"active-response"},"command":"check_keys", "parameters":{"keys":[]}}\n'

         read RESPONSE
         COMMAND2=$(echo $RESPONSE | jq -r .command)
         if [ ${COMMAND2} != "continue" ]; then
             echo "`date '+%Y/%m/%d %H:%M:%S'` $0: $INPUT_JSON Remove threat active response aborted" >> ${LOG_FILE}
             exit 0;
         fi
     fi

     rm -f $FILENAME
     if [ $? -eq 0 ]; then
         echo "`date '+%Y/%m/%d %H:%M:%S'` $0: $INPUT_JSON Successfully removed threat" >> ${LOG_FILE}
     else
         echo "`date '+%Y/%m/%d %H:%M:%S'` $0: $INPUT_JSON Error removing threat" >> ${LOG_FILE}
     fi

     exit 0;
     ```
   - Update ownership and permissions:
     ```bash
     sudo chmod 750 /var/ossec/active-response/bin/remove-threat.sh
     sudo chown root:wazuh /var/ossec/active-response/bin/remove-threat.sh
     ```

4. **Restart Wazuh Agent:**
   ```bash
   sudo systemctl restart wazuh-agent
   ```

### Step 2: Configure Wazuh Server

1. **Add Local Rules:**
   - Add the following rules to `/var/ossec/etc/rules/local_rules.xml`:
     ```xml
     <group name="syscheck,pci_dss_11.5,nist_800_53_SI.7,">
         <rule id="100200" level="7">
             <if_sid>550</if_sid>
             <field name="file">/root</field>
             <description>File modified in /root directory.</description>
         </rule>
         <rule id="100201" level="7">
             <if_sid>554</if_sid>
             <field name="file">/root</field>
             <description>File added to /root directory.</description>
         </rule>
     </group>
     ```

2. **Enable VirusTotal Integration:**
   - Add the following to `/var/ossec/etc/ossec.conf`:
     ```xml
     <ossec_config>
       <integration>
         <name>virustotal</name>
         <api_key><YOUR_VIRUS_TOTAL_API_KEY></api_key>
         <rule_id>100200,100201</rule_id>
         <alert_format>json</alert_format>
       </integration>
     </ossec_config>
     ```

3. **Enable Active Response:**
   - Append the following to `/var/ossec/etc/ossec.conf`:
     ```xml
     <ossec_config>
       <command>
         <name>remove-threat</name>
         <executable>remove-threat.sh</executable>
         <timeout_allowed>no</timeout_allowed>
       </command>

       <active-response>
         <disabled>no</disabled>
         <command>remove-threat</command>
         <location>local</location>
         <rules_id>87105</rules_id>
       </active-response>
     </ossec_config>
     ```

4. **Restart Wazuh Manager:**
   ```bash
   sudo systemctl restart wazuh-manager
   ```

### Step 3: Test Configuration

1. **Download EICAR Test File:**
   ```bash
   sudo curl -Lo /root/eicar.com https://secure.eicar.org/eicar.com && sudo ls -lah /root/eicar.com
   ```
2. **Verify Alerts:**
   - Open the Wazuh dashboard and query the following:
     ```
     rule.id: is one of 553,100092,87105,100201
     ```

---

## Configuration for Windows Endpoint

### Step 1: Configure Wazuh Agent

1. **Enable FIM Monitoring:**
   - Open `C:\Program Files (x86)\ossec-agent\ossec.conf`.
   - Ensure `<disabled>` is set to `no` in the `<syscheck>` block:
     ```xml
     <syscheck>
         <disabled>no</disabled>
     </syscheck>
     ```
   - Add the following entry to monitor the `C:\Users\<USER_NAME>\Downloads` directory:
     ```xml
     <directories realtime="yes">C:\Users\<USER_NAME>\Downloads</directories>
     ```

2. **Install Python and PyInstaller:**
   - Download and install Python, ensuring you check:
     - "Install launcher for all users"
     - "Add Python 3.X to PATH"
   - Open PowerShell as Administrator and install PyInstaller:
     ```powershell
     pip install pyinstaller
     ```

3. **Create Active Response Script:**
   - Save the provided `remove-threat.py` script.
   - Convert it to an executable:
     ```powershell
     pyinstaller -F \path_to_remove-threat.py
     ```
   - Move `remove-threat.exe` to `C:\Program Files (x86)\ossec-agent\active-response\bin`.

4. **Restart Wazuh Agent:**
   ```powershell
   Restart-Service -Name wazuh
   ```

### Step 2: Configure Wazuh Server

1. **Enable VirusTotal Integration:**
   - Add the following to `/var/ossec/etc/ossec.conf`:
     ```xml
     <ossec_config>
       <integration>
         <name>virustotal</name>
         <api_key><YOUR_VIRUS_TOTAL_API_KEY></api_key>
         <group>syscheck</group>
         <alert_format>json</alert_format>
       </integration>
     </ossec_config>
     ```

2. **Enable Active Response:**
   - Append the following to `/var/ossec/etc/ossec.conf`:
     ```xml
     <ossec_config>
       <command>
         <name>remove-threat</name>
         <executable>remove-threat.exe</executable>
         <timeout_allowed>no</timeout_allowed>
       </command>

       <active-response>
         <disabled>no</disabled>
         <command>remove-threat</command>
         <location>local</location>
         <rules_id>87105</rules_id>
       </active-response>
     </ossec_config>
     ```

3. **Restart Wazuh Manager:**
   ```bash
   sudo systemctl restart wazuh-manager
   ```

### Step 3: Test Configuration

1. **Disable Real-Time Antivirus Protection:**
   - Open Windows Security and turn off real-time protection.

2. **Download EICAR Test File:**
   ```powershell
   Invoke-WebRequest -Uri https://secure.eicar.org/eicar.com.txt -OutFile eicar.txt
   cp .\eicar.txt C:\Users\<USER_NAME>\Downloads
   ```
3. **Verify Alerts:**
   - Check the Wazuh dashboard for alerts.

---

This concludes the setup for detecting and removing malware using VirusTotal integration with Wazuh.
